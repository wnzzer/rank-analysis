name: Release Build

on:
  workflow_dispatch:
    inputs:
      notes:
        description: 'Release Notes (optional)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Upload Assets (Windows)
    runs-on: windows-latest
    
    # ÂÆö‰πâÂÖ®Â±ÄÂ∑•‰ΩúÁõÆÂΩïÔºåÈÄÇÁî®‰∫éÊâÄÊúâ run Ê≠•È™§
    defaults:
      run:
        working-directory: ./lol-record-analysis-tauri
    
    # ÂØºÂá∫ÁâàÊú¨Âè∑Áªô‰∏ã‰∏Ä‰∏™ Job ‰ΩøÁî®
    outputs:
      tauri_version: ${{ steps.get_version.outputs.tauri_version }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: lol-record-analysis-tauri/package-lock.json

      - name: ü¶Ä Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: üì¶ Install dependencies
        run: npm ci

      # --- Ê†∏ÂøÉÊ≠•È™§ÔºöÊô∫ËÉΩËé∑ÂèñÁâàÊú¨Âè∑ ---
      - name: üîç Get App Version
        id: get_version
        shell: pwsh
        run: |
          $configPath = "src-tauri/tauri.conf.json"
          # ËØªÂèñ JSON ÈÖçÁΩÆ
          $configJson = Get-Content $configPath | Out-String | ConvertFrom-Json
          
          # Â∞ùËØïËØªÂèñ version (ÈÄÇÈÖç Tauri v1 package.version Âíå Tauri v2 top-level version)
          if ($configJson.version) {
              $tauriVersion = $configJson.version
          } elseif ($configJson.package.version) {
              $tauriVersion = $configJson.package.version
          }

          # Â¶ÇÊûú‰∏∫Á©∫ÔºåÂ∞ùËØïËØªÂèñ Cargo.toml
          if ([string]::IsNullOrEmpty($tauriVersion)) {
              Write-Host "tauri.conf.json version is empty. Checking Cargo.toml..."
              $tomlPath = "src-tauri/Cargo.toml"
              $tomlContent = Get-Content $tomlPath | Select-String -Pattern '^version\s*=\s*"(.+?)"' 
              
              if ($tomlContent) {
                  $tauriVersion = $tomlContent.Matches[0].Groups[1].Value
              } else {
                  Write-Error "Could not find version in tauri.conf.json or Cargo.toml"
                  exit 1
              }
          }
          Write-Host "Detected Tauri Version: $tauriVersion"

          # Á°Æ‰øùÁâàÊú¨Âè∑‰ª• 'v' ÂºÄÂ§¥ (GitHub Release ÊÉØ‰æã)
          if ($tauriVersion -notlike 'v*') {
              $tauriVersion = "v$tauriVersion"
          }
          
          Write-Host "Final Release Version: $tauriVersion"
          echo "tauri_version=$tauriVersion" >> $env:GITHUB_OUTPUT

      - name: üïµÔ∏è Debug Secrets (Safe)
        shell: pwsh
        run: |
          if ($env:MY_KEY) { 
              Write-Host "‚úÖ Private Key is detected! Length: $($env:MY_KEY.Length)" 
              # Check if it looks like a minisign key
              if ($env:MY_KEY -match "untrusted comment:") {
                  Write-Host "‚úÖ Key format looks correct (contains 'untrusted comment')."
              } else {
                  Write-Warning "‚ö†Ô∏è Key format might be incorrect. It should usually start with 'untrusted comment:'."
              }
          } else { 
              Write-Error "‚ùå Private Key is MISSING or EMPTY!" 
          }
          
          if ($env:MY_PWD) { 
              Write-Host "‚úÖ Password is detected!" 
          } else { 
              Write-Warning "‚ö†Ô∏è Password is MISSING (If you have no password, ignore this)" 
          }
        env:
          MY_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          MY_PWD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

      # --- ÊûÑÂª∫Âπ∂Á≠æÂêç ---
      - name: üî® Build Tauri App (Signed)
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }} # ÂÖºÂÆπÊóßÁâà
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}
          TAURI_SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }} # ÂÖºÂÆπÊóßÁâà

      - name: üìÇ List Build Artifacts (Debug)
        shell: pwsh
        run: |
          Write-Host "Listing src-tauri/target/release/bundle/nsis:"
          Get-ChildItem -Path "src-tauri/target/release/bundle/nsis" -Recurse | Format-Table Name, Length, LastWriteTime


      # --- Êñá‰ª∂ÈáçÂëΩÂêç„ÄÅÂéãÁº©‰∏éË∑ØÂæÑÊï¥ÁêÜ ---
      - name: üìù Rename, Compress, and Set Paths
        id: prepare_assets
        shell: pwsh
        run: |
          # Ëé∑Âèñ‰∏ä‰∏ÄÊ≠•Ëß£ÊûêÂá∫ÁöÑÁâàÊú¨Âè∑
          $version = "${{ steps.get_version.outputs.tauri_version }}" 
          $cleanVersion = $version -replace '^v',''
          
          $nsisDir = "src-tauri/target/release/bundle/nsis"
          $releaseDir = "src-tauri/target/release"
          $appName = "lol-record-analysis-app"

          # 1. Â§ÑÁêÜÂÆâË£ÖÂåÖ (.exe) Âíå Á≠æÂêçÊñá‰ª∂ (.sig)
          $installerFile = Get-ChildItem -Path $nsisDir -Filter "*.exe" -ErrorAction Stop
          $sigFile = Get-ChildItem -Path $nsisDir -Filter "*.sig" -ErrorAction SilentlyContinue

          if ($installerFile.Count -ne 1) { 
            Write-Error "Expected 1 installer file, found $($installerFile.Count)"
            exit 1 
          }
          
          $setupName = "$appName-$cleanVersion-setup.exe"
          Rename-Item -Path $installerFile[0].FullName -NewName $setupName

          $sigPath = ""
            $sigName = "$setupName.sig"
            if ($sigFile.Count -gt 0) {
              # Â¶ÇÊûú tauri build Â∑≤ÁªèÁîüÊàê‰∫ÜÁ≠æÂêçÊñá‰ª∂ÔºåÁªü‰∏ÄÊîπÂêç‰∏∫‰∏éÂÆâË£ÖÂåÖ‰∏ÄËá¥
              Rename-Item -Path $sigFile[0].FullName -NewName $sigName
            } else {
              # ‰∏Ä‰∫õ Tauri / bundler ÁªÑÂêà‰∏ç‰ºöÂú® NSIS ÁõÆÂΩï‰∏ãËá™Âä®ËæìÂá∫ .sig
              # ËøôÈáåÊòæÂºèÂØπ‚ÄúÂÆâË£ÖÂåÖÊñá‰ª∂Êú¨Ë∫´‚ÄùÁîüÊàê updater Áî®ÁöÑ minisign Á≠æÂêç
              Write-Host "No .sig found in NSIS output. Generating with 'tauri signer sign'..."

              $installerPath = Join-Path $nsisDir $setupName
              if (-not (Test-Path $installerPath)) {
                Write-Error "Installer not found at $installerPath"
                exit 1
              }

              if ([string]::IsNullOrEmpty($env:TAURI_PRIVATE_KEY)) {
                Write-Error "TAURI_PRIVATE_KEY is missing; cannot sign installer."
                exit 1
              }

              # Â¶ÇÊûú‰Ω†ÁöÑ key ÊòØÁ©∫ÂØÜÁ†ÅÔºåËøôÈáå‰øùËØÅÂèòÈáèÂ≠òÂú®ÔºåÈÅøÂÖç CLI ‰∫§‰∫íÊèêÁ§∫
              if ($null -eq $env:TAURI_PRIVATE_KEY_PASSWORD) {
                $env:TAURI_PRIVATE_KEY_PASSWORD = ""
              }

              npx tauri signer sign "$installerPath"
            }

            $sigCandidate = Join-Path $nsisDir $sigName
            if (Test-Path $sigCandidate) {
              $sigPath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$nsisDir/$sigName"
            } else {
                Write-Error "Signature file missing: $sigCandidate"
                exit 1
            }

          # 2. Â§ÑÁêÜÁªøËâ≤Áâà (Portable .7z)
          $exeName = "$appName.exe"
          $portable7zName = "$appName-$cleanVersion-portable.7z"
          
          if (Test-Path "$releaseDir/$exeName") {
            Push-Location $releaseDir
            7z a -t7z $portable7zName $exeName
            Pop-Location
          } else {
            Write-Error "Main executable not found for portable packing."
            exit 1
          }

          # 3. ËæìÂá∫‰æõ Release Ê≠•È™§‰ΩøÁî®ÁöÑË∑ØÂæÑ
          $setupPath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$nsisDir/$setupName"
          $portablePath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$releaseDir/$portable7zName"
          
          echo "setup_path=$setupPath" >> $env:GITHUB_OUTPUT
          echo "portable_path=$portablePath" >> $env:GITHUB_OUTPUT
          echo "sig_path=$sigPath" >> $env:GITHUB_OUTPUT 
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

      - name: ‚ö° Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: üìù Generate Changelog
        working-directory: .
        run: git-cliff --config .github/cliff.toml --verbose --tag ${{ steps.get_version.outputs.tauri_version }} --unreleased --strip header --output lol-record-analysis-tauri/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìÑ Prepare Release Body
        shell: pwsh
        run: |
          $notes = "${{ github.event.inputs.notes }}"
          $changelog = Get-Content CHANGELOG.md -Raw
          
          if (-not [string]::IsNullOrWhiteSpace($notes)) {
              Set-Content -Path RELEASE_BODY.md -Value "$notes`n`n$changelog"
          } else {
              Set-Content -Path RELEASE_BODY.md -Value $changelog
          }
        
      # --- ÂàõÂª∫ Release Âπ∂‰∏ä‰º†ËµÑÊ∫ê ---
      - name: üöÄ Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tauri_version }}
          name: Release ${{ steps.get_version.outputs.tauri_version }}
          body_path: RELEASE_BODY.md
          files: |
            ${{ steps.prepare_assets.outputs.setup_path }}
            ${{ steps.prepare_assets.outputs.portable_path }}
          draft: false
          prerelease: false

      # --- ÁîüÊàê latest.json ---
      - name: üìù Generate latest.json
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");
            
            const version = process.env.VERSION;
            const notes = process.env.NOTES || "For details, please check the GitHub Release page.";
            const setupPath = process.env.SETUP_PATH;
            const sigPath = process.env.SIG_PATH;
            
            const exeFile = path.basename(setupPath);
            let signature = "";
            
            if (sigPath && fs.existsSync(sigPath)) {
                signature = fs.readFileSync(sigPath, "utf8");
                console.log("Signature loaded successfully.");
            } else {
                console.warn("WARNING: Signature file missing or empty.");
            }
            
            const data = {
                version: version,
                notes: notes,
                pub_date: new Date().toISOString(),
                platforms: {
                    "windows-x86_64": {
                        signature: signature,
                        url: `https://github.com/wnzzer/rank-analysis/releases/download/${version}/${exeFile}`
                    }
                }
            };
            
            fs.writeFileSync("latest.json", JSON.stringify(data, null, 2));
            console.log("latest.json generated.");
          '
        env:
          VERSION: ${{ steps.get_version.outputs.tauri_version }}
          NOTES: ${{ github.event.inputs.notes }}
          SETUP_PATH: ${{ steps.prepare_assets.outputs.setup_path }}
          SIG_PATH: ${{ steps.prepare_assets.outputs.sig_path }}

      # --- ‰∏ä‰º† latest.json ---
      - name: ‚¨ÜÔ∏è Upload latest.json Asset
        uses: softprops/action-gh-release@v2 
        with:
          tag_name: ${{ steps.get_version.outputs.tauri_version }}
          files: lol-record-analysis-tauri/latest.json


  # --- ‰ªªÂä°‰∫åÔºöÈÄöÁü• UpgradeLink ---
  upgradelink-upload:
    name: Notify UpgradeLink Service
    needs: build-and-release
    permissions:
      contents: write 
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚è≥ Wait for Release Assets
        run: sleep 30 

      - name: üîó Send a request to UpgradeLink
        uses: toolsetlink/upgradelink-action@v5
        with:
          # ‰ΩøÁî® needs.build-and-release.outputs.tauri_version Ëé∑ÂèñÁâàÊú¨Âè∑
          source-url: 'https://github.com/wnzzer/rank-analysis/releases/download/${{ needs.build-and-release.outputs.tauri_version }}/latest.json'
          access-key: ${{ secrets.UPGRADE_LINK_ACCESS_KEY }}
          tauri-key: ${{ secrets.UPGRADE_LINK_TAURI_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}