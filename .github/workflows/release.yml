name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release Notes'
        required: true
        default: 'Update details...'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./lol-record-analysis-tauri

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: lol-record-analysis-tauri/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri App
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

      - name: Rename and Compress Binary
        id: rename
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          # Remove 'v' prefix if present
          $cleanVersion = $version -replace '^v',''
          
          # Path relative to the working directory (lol-record-analysis-tauri)
          $targetDir = "src-tauri/target/release/bundle/nsis"
          
          # Find the setup .exe file
          $files = Get-ChildItem -Path $targetDir -Filter "*.exe"
          
          if ($files.Count -eq 0) {
             Write-Error "No installer found in $targetDir"
             exit 1
          }
          
          $file = $files[0]
          $newName = "lol-record-analysis-app-$cleanVersion-setup.exe"
          
          # Rename the file
          Rename-Item -Path $file.FullName -NewName $newName
          
          # Compress to 7z
          $7zName = "lol-record-analysis-app-$cleanVersion-setup.7z"
          
          # Switch to target directory to compress without path structure
          Push-Location $targetDir
          7z a $7zName $newName
          Pop-Location
          
          # Construct the path relative to the repository root for action-gh-release
          $artifactPath = "lol-record-analysis-tauri/$targetDir/$7zName"
          $exePath = "lol-record-analysis-tauri/$targetDir/$newName"
          
          Write-Host "Compressed $newName to $7zName"
          Write-Host "Artifact path for upload: $artifactPath"
          Write-Host "Exe path for upload: $exePath"
          
          $latestJsonPath = "lol-record-analysis-tauri/$targetDir/latest.json"
          
          echo "artifact_path=$artifactPath" >> $env:GITHUB_OUTPUT
          echo "exe_path=$exePath" >> $env:GITHUB_OUTPUT
          echo "latest_json_path=$latestJsonPath" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.notes }}
          files: |
            ${{ steps.rename.outputs.artifact_path }}
            ${{ steps.rename.outputs.exe_path }}
            ${{ steps.rename.outputs.latest_json_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upgradeLink-upload:
    needs: build-and-release
    permissions:
      contents: write 
    runs-on: ubuntu-latest
    steps:
      - name: Send a request to UpgradeLink
        uses: toolsetlink/upgradelink-action@v5
        with:
          source-url: 'https://github.com/wnzzer/rank-analysis/releases/download/${{ github.event.inputs.version }}/latest.json'
          access-key: ${{ secrets.UPGRADE_LINK_ACCESS_KEY }}
          tauri-key: ${{ secrets.UPGRADE_LINK_TAURI_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
