name: Release Build

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘ã€‚version è¾“å…¥é¡¹æ”¹ä¸ºéå¿…é¡»ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šè‡ªåŠ¨è¯»å–ã€‚
  workflow_dispatch:
    inputs:
      notes:
        description: 'Release Notes'
        required: true
        default: 'Update details...'
      # ä¿ç•™ version å­—æ®µä½†è®¾ç½®ä¸ºéå¿…é¡»ï¼Œä»¥ä¾¿åœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ‰‹åŠ¨è¦†ç›–
      version_override:
        description: 'Optional: Override App Version (e.g. v1.0.0)'
        required: false
        default: ''

# æˆäºˆå·¥ä½œæµå†™å…¥å†…å®¹çš„æƒé™
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Upload Assets (Windows)
    runs-on: windows-latest
    
    # ç»Ÿä¸€è®¾ç½®å·¥ä½œç›®å½•
    defaults:
      run:
        working-directory: ./lol-record-analysis-tauri

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: lol-record-analysis-tauri/package-lock.json

      - name: ğŸ¦€ Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # æ–°å¢æ­¥éª¤ï¼šä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ç‰ˆæœ¬å·
      - name: ğŸ” Get App Version
        id: get_version
        shell: pwsh
        run: |
          $overrideVersion = "${{ github.event.inputs.version_override }}"
          
          if ($overrideVersion) {
              Write-Host "Using override version: $overrideVersion"
              $tauriVersion = $overrideVersion
          } else {
              $configPath = "src-tauri/tauri.conf.json"
              $configJson = Get-Content $configPath | Out-String | ConvertFrom-Json
              
              # å°è¯•ä» tauri.conf.json çš„ package.version å­—æ®µè¯»å–
              $tauriVersion = $configJson.package.version

              if ([string]::IsNullOrEmpty($tauriVersion)) {
                  Write-Host "tauri.conf.json version field is empty. Attempting to read Cargo.toml..."
                  
                  # å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå›é€€åˆ° Cargo.toml
                  $tomlPath = "src-tauri/Cargo.toml"
                  $tomlContent = Get-Content $tomlPath | Select-String -Pattern '^version\s*=\s*"(.+?)"' 
                  
                  if ($tomlContent) {
                      $tauriVersion = $tomlContent.Matches[0].Groups[1].Value
                  } else {
                      Write-Error "Could not find version in tauri.conf.json or Cargo.toml."
                      exit 1
                  }
              }
              Write-Host "Detected Tauri Version: $tauriVersion"
          }

          # ç¡®ä¿ç‰ˆæœ¬å¸¦æœ‰ 'v' å‰ç¼€ï¼Œè¿™æ˜¯ GitHub Release çš„ä¹ æƒ¯ç”¨æ³•
          if ($tauriVersion -notlike 'v*') {
              $tauriVersion = "v$tauriVersion"
          }
          
          # å°†æœ€ç»ˆç‰ˆæœ¬è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          echo "tauri_version=$tauriVersion" >> $env:GITHUB_OUTPUT
          
      # æ ¸å¿ƒæ„å»ºæ­¥éª¤
      - name: ğŸ”¨ Build Tauri App (Signed)
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_KEY_PASSWORD }}

      # æ•´åˆæ–‡ä»¶å¤„ç†ã€é‡å‘½åå’Œå‹ç¼©é€»è¾‘
      - name: ğŸ“ Rename, Compress, and Set Paths
        id: prepare_assets
        shell: pwsh
        run: |
          # **ä»ä¸Šä¸€æ­¥éª¤çš„è¾“å‡ºä¸­è·å–ç‰ˆæœ¬å·**
          $version = "${{ steps.get_version.outputs.tauri_version }}" 
          $cleanVersion = $version -replace '^v','' # ç§»é™¤ 'v' å‰ç¼€ç”¨äºæ–‡ä»¶å
          
          # å®šä¹‰ä¸»è¦è·¯å¾„
          $nsisDir = "src-tauri/target/release/bundle/nsis"
          $releaseDir = "src-tauri/target/release"
          $appName = "lol-record-analysis-app"

          # --- 1. å¤„ç†å®‰è£…ç‰ˆ (Setup .exe) å’Œç­¾å (.sig) ---
          $installerFile = Get-ChildItem -Path $nsisDir -Filter "*.exe" -ErrorAction Stop
          $sigFile = Get-ChildItem -Path $nsisDir -Filter "*.sig" -ErrorAction SilentlyContinue

          if ($installerFile.Count -ne 1) { exit 1 }
          
          $setupName = "$appName-$cleanVersion-setup.exe"
          Rename-Item -Path $installerFile[0].FullName -NewName $setupName

          $sigPath = "" # åˆå§‹åŒ–ç­¾åè·¯å¾„
          if ($sigFile.Count -gt 0) {
              $sigName = "$setupName.sig"
              Rename-Item -Path $sigFile[0].FullName -NewName $sigName
              # è®¾ç½®ç­¾åæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
              $sigPath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$nsisDir/$sigName" 
          }

          # --- 2. å¤„ç†ç»¿è‰²ç‰ˆ (Portable .7z) ---
          $exeName = "$appName.exe"
          $portable7zName = "$appName-$cleanVersion-portable.7z"
          
          Push-Location $releaseDir
          7z a -t7z $portable7zName $exeName
          Pop-Location

          # --- 3. è¾“å‡ºè·¯å¾„ (ç›¸å¯¹ä»“åº“æ ¹ç›®å½•) ---
          $setupPath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$nsisDir/$setupName"
          $portablePath = "$($env:GITHUB_WORKSPACE)/lol-record-analysis-tauri/$releaseDir/$portable7zName"
          
          echo "setup_path=$setupPath" >> $env:GITHUB_OUTPUT
          echo "portable_path=$portablePath" >> $env:GITHUB_OUTPUT
          echo "sig_path=$sigPath" >> $env:GITHUB_OUTPUT 

      # åˆ›å»º Release å¹¶ä¸Šä¼ å®‰è£…åŒ…å’Œç»¿è‰²ç‰ˆ
      - name: ğŸš€ Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          # **ä½¿ç”¨è‡ªåŠ¨è¯»å–çš„ç‰ˆæœ¬**
          tag_name: ${{ steps.get_version.outputs.tauri_version }} 
          name: Release ${{ steps.get_version.outputs.tauri_version }}
          body: ${{ github.event.inputs.notes }}
          files: |
            ${{ steps.prepare_assets.outputs.setup_path }}
            ${{ steps.prepare_assets.outputs.portable_path }}
          draft: false
          prerelease: false

      # ç”Ÿæˆ latest.json
      - name: ğŸ“ Generate latest.json
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");
            
            // ä½¿ç”¨è‡ªåŠ¨è¯»å–çš„ç‰ˆæœ¬
            const version = process.env.VERSION;
            const notes = process.env.NOTES;
            
            const setupPath = process.env.SETUP_PATH;
            const sigPath = process.env.SIG_PATH;
            
            // æå–æ–‡ä»¶å
            const exeFile = path.basename(setupPath);
            
            let signature = "";
            
            // è¯»å–ç­¾åæ–‡ä»¶å†…å®¹ï¼Œç¡®ä¿ latest.json ä¸­çš„ signature å­—æ®µæœ‰å€¼
            if (fs.existsSync(sigPath)) {
                signature = fs.readFileSync(sigPath, "utf8");
            } else {
                console.warn("Signature file not found, latest.json will have empty signature.");
            }
            
            const data = {
                version: version,
                notes: notes,
                pub_date: new Date().toISOString(),
                platforms: {
                    "windows-x86_64": {
                        signature: signature,
                        // æ„é€  URL
                        url: `https://github.com/wnzzer/rank-analysis/releases/download/${version}/${exeFile}`
                    }
                }
            };
            
            // åœ¨å·¥ä½œç›®å½•çš„æ ¹ç›®å½•ç”Ÿæˆ latest.json 
            fs.writeFileSync("latest.json", JSON.stringify(data, null, 2));
          '
        env:
          VERSION: ${{ steps.get_version.outputs.tauri_version }} # ä½¿ç”¨è‡ªåŠ¨è¯»å–çš„ç‰ˆæœ¬
          NOTES: ${{ github.event.inputs.notes }}
          SETUP_PATH: ${{ steps.prepare_assets.outputs.setup_path }}
          SIG_PATH: ${{ steps.prepare_assets.outputs.sig_path }}
          
      # ä¸Šä¼  latest.json åˆ° Release
      - name: â¬†ï¸ Upload latest.json Asset
        uses: softprops/action-gh-release@v2 
        with:
          tag_name: ${{ steps.get_version.outputs.tauri_version }}
          files: lol-record-analysis-tauri/latest.json
          overwrite: true
          
  # --- ç¬¬äºŒä¸ª Job: æ›´æ–°å¤–éƒ¨é“¾æ¥ ---
  upgradelink-upload:
    name: Notify UpgradeLink Service
    needs: build-and-release
    permissions:
      contents: write 
    runs-on: ubuntu-latest
    
    steps:
      - name: â³ Wait for Release Assets
        run: sleep 30 
      
      # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ä½¿ç”¨æ­¥éª¤ get_version çš„è¾“å‡º
      - name: ğŸ”— Send a request to UpgradeLink
        uses: toolsetlink/upgradelink-action@v5
        with:
          # ä»ä¸Šä¸€ä¸ª Job å¼•ç”¨ç‰ˆæœ¬å·
          source-url: 'https://github.com/wnzzer/rank-analysis/releases/download/${{ needs.build-and-release.outputs.tauri_version }}/latest.json'
          access-key: ${{ secrets.UPGRADE_LINK_ACCESS_KEY }}
          tauri-key: ${{ secrets.UPGRADE_LINK_TAURI_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
# å¿…é¡»å®šä¹‰è¾“å‡ºï¼Œä»¥ä¾¿åœ¨ç¬¬äºŒä¸ª Job ä¸­ä½¿ç”¨
# (å› ä¸º get_version.outputs.tauri_version åœ¨ç¬¬ä¸€ä¸ª Job ä¸­)
on:
  workflow_dispatch:
    inputs:
      # ... (inputs ä¿æŒä¸å˜)
      
# ... (permissions ä¿æŒä¸å˜)

jobs:
  build-and-release:
    name: Build & Upload Assets (Windows)
    runs-on: windows-latest
    # **æ–°å¢ job è¾“å‡ºï¼Œå°†ç‰ˆæœ¬å·ä¼ é€’ç»™ä¸‹ä¸€ä¸ª job**
    outputs:
      tauri_version: ${{ steps.get_version.outputs.tauri_version }}
      
# ... (Steps ä¿æŒä¸å˜)